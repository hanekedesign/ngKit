!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("lodash"),require("rxjs"),require("localforage"),require("@angular/common/http"),require("moment"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("ngkit",["exports","@angular/core","lodash","rxjs","localforage","@angular/common/http","moment","rxjs/operators"],e):e(t.ngkit={},t.ng.core,null,t.rxjs,null,t.ng.common.http,null,t.rxjs.operators)}(this,function(t,o,r,e,n,i,s,u){"use strict";var c=function(){function n(t){this._options=t,this.options=n.defaultOptions,this.setOptions(this._options)}return n.prototype.getOptions=function(){return this.options},n.prototype.get=function(t,e){return void 0===e&&(e=!1),n.getItem(t,e)},n.getItem=function(t,e){return e||(n.defaultOptions?t.split(".").reduce(function(t,e){return t[e]},n.defaultOptions):void 0)},n.prototype.setItem=function(t,e){return r.set(this.options,t,e)},n.prototype.setOptions=function(t){return this.options=r.merge(this.options,t),this},n.defaultOptions={authentication:{endpoints:{check:"",forogotPassword:"",getUser:"",login:"",logout:"",register:"",resetPassword:"",socialAuth:""},method:{token:!0},social:{facebook:{id:"",version:"v2.6",xfbml:!0,scope:"public_profile,email"},twitter:{id:""},redirectTo:"",oauthProxy:""}},authorization:{},http:{baseUrl:"",headers:{}},storage:{name:"ngkitStorage"},token:{readAs:"token",storeAs:"_token",scheme:"Bearer"},cache:{expires:5},debug:!1},n.decorators=[{type:o.Injectable}],n.ctorParameters=function(){return[{type:undefined,decorators:[{type:o.Inject,args:["ngKitOptions"]}]}]},n}(),a=function(){function n(){}return n.channel=function(t){return"undefined"==typeof n.channels[t]&&(n.channels[t]=new e.Subject),n.channels[t]},n.prototype.setChannels=function(t){t.forEach(function(t){return n.channel(t)})},n.prototype.broadcast=function(t,e){return void 0===e&&(e={}),Promise.resolve(n.channel(t).next(e))},n.prototype.listen=function(t){return n.channel(t).asObservable()},n.channels=[],n.decorators=[{type:o.Injectable}],n}(),h=function(){function t(t){this.config=t,this.db=n.createInstance({name:this.config.get("storage.name")})}return t.prototype.get=function(t){return this.db.getItem(t)},t.prototype.set=function(t,e){return this.db.setItem(t,e)},t.prototype.remove=function(t){return this.db.removeItem(t)},t.prototype.clear=function(){return this.db.clear()},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:c}]},t}(),f=function(){function t(t,e){this.config=t,this.storage=e,this._token="_token"}return t.prototype.get=function(t){var o=this;return new Promise(function(e,n){t=t||o.config.get("token.name",o._token),o.storage.get(t).then(function(t){e(t)},function(t){return n(t)})})},t.prototype.set=function(n,o){var r=this;return new Promise(function(t,e){o=o||r.config.get("token.name",r._token),n?r.storage.set(o,n).then(function(){t(!0)},function(){return e("Error: Could not store token.")}):e("Error: No token provided.")})},t.prototype.remove=function(t){return t=t||this.config.get("token.name",this._token),this.storage.remove(t),!0},t.prototype.read=function(t){return void 0===t&&(t=null),t?this.config.get("token.readAs").split(".").reduce(function(t,e){return t[e]},t):null},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:c},{type:h}]},t}(),p=function(){function t(t,e,n){this.config=t,this.event=e,this.token=n,this.baseUrl="",this.headers=new i.HttpHeaders,this.subs={},this.setDefaultHeaders(),this.eventListeners()}return t.prototype.ngOnDestroy=function(){var e=this;Object.keys(this.subs).forEach(function(t){return e.subs[t].unsubscribe()})},t.prototype.buildParams=function(e){var n=new i.HttpParams;return e&&Object.keys(e).forEach(function(t){e[t]&&n.set(t,e[t])}),n},t.prototype.eventListeners=function(){var t=this;if(this.event){var e=function(){return t.setDefaultHeaders()};this.subs["auth:loggingIn"]=this.event.listen("auth:loggingIn").subscribe(e),this.subs["auth:loggedOut"]=this.event.listen("auth:loggedOut").subscribe(e),this.subs["auth:check"]=this.event.listen("auth:check").subscribe(e)}},t.prototype.getUrl=function(t){if(t.startsWith("/")||t.startsWith("http"))return t;var e=this.baseUrl||this.config.get("http.baseUrl")||"";return e?e+"/"+t:t},t.prototype.setDefaultHeaders=function(){var e=this,n=this.config?this.config.get("http.headers"):null;n&&Object.keys(n).forEach(function(t){e.headers=e.headers.set(t,n[t])}),this.tokenHeader()},t.prototype.tokenHeader=function(){var r=this;return new Promise(function(o){r.config&&r.config.get("authentication.method.token")&&r.token.get().then(function(t){var e=r.config.get("token.scheme"),n=e?e+" "+t:t;r.headers=r.headers.set("Authorization",n),o(!!t)},function(){r.headers=r.headers["delete"]("Authorization"),o(!1)})})},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:c},{type:a},{type:f}]},t}(),l=function(){function t(t){Object.assign(this,t)}return Object.defineProperty(t.prototype,"value",{get:function(){return JSON.parse(this._value)},set:function(t){this._value=JSON.stringify(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"expires",{get:function(){return this._expires},set:function(t){var e=new Date;e.setMinutes(e.getMinutes()+t),this._expires=e.getTime()},enumerable:!0,configurable:!0}),t.prototype.isExpired=function(){return this.expires<=(new Date).getTime()},t}(),d=function g(t){this.moment=s,"string"==typeof t&&(t=JSON.parse(t)),Object.assign(this,t)},y=function v(t){this.objects=[],Object.assign(this,t)},b=function(){function t(t,e){this.authorization=t,this.user=e,Object.assign(this,e)}return t.prototype.can=function(t,e){return this.authorization.checkPolicy(t,e)},t.prototype.cannot=function(t,e){return!this.authorization.checkPolicy(t,e)},t.prototype.allow=function(t,e,n){return"function"==typeof n&&n()?this.authorization.addPolicy(t,e):"boolean"==typeof n&&n?this.authorization.addPolicy(t,e):this.authorization.removePolicy(t,e),this},t.prototype.disallow=function(t,e){return this.authorization.removePolicy(t,e),this},t.prototype.identify=function(t){return this.authorization.addPolicy("roles",t),this},t.prototype.is=function(t){return this.authorization.checkPolicy("roles",t)},t.prototype.isNot=function(t){return!this.authorization.checkPolicy("roles",t)},t}(),m=function(){function t(){this.policies=[]}return t.prototype.addPolicy=function(e,t){if(this.policies.findIndex(function(t){return t.name==e})<0){var n=new y({name:e});return t&&n.objects.push(t),this.policies.push(n),!0}var o=this.policies.findIndex(function(t){return t.name==e});return!(!t||this.policies[o].objects[t])&&(this.policies[o].objects.push(t),!0)},t.prototype.checkPolicy=function(e,t){void 0===t&&(t=null);var n=this.policies.find(function(t){return t.name===e});return n&&!0,!(!n||!(t&&0<=n.objects.indexOf(t)||!t&&!n.objects.length))},t.prototype.clearPolicies=function(){this.policies=[]},t.prototype.removePolicy=function(e,n){var o=this.policies.find(function(t){return t.name===e});if(o&&0<=o.objects.indexOf(n)){var t=this.policies.findIndex(function(t){return t.name===name}),r=[];return o.objects.forEach(function(t,e){t==n&&r.push(e)}),r.forEach(function(t){return delete o.objects[t]}),this.policies[t]=o,!0}return!1},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[]},t}(),k=function(){function t(t,e,n,o,r,i){var s=this;this.authorization=t,this.config=e,this.event=n,this.http=o,this.httpService=r,this.token=i,this.authUser=null,this.channels=["auth:login","auth:logginIn","auth:loggedIn","auth:logout","auth:loggingOut","auth:loggedOut","auth:required","auth:check","auth:guarded","auth:registered"],this.redirect=null,this.subs={},this.timeouts={},this.user=function(){return s.authUser},this.event.setChannels(this.channels),this.eventListeners()}return t.prototype.ngOnDestroy=function(){var e=this;Object.keys(this.subs).forEach(function(t){return e.subs[t].unsubscribe()}),Object.keys(this.timeouts).forEach(function(t){return clearTimeout(e.timeouts[t])})},t.prototype.check=function(t){var n=this;void 0===t&&(t=!1);var o=this.config.get("authentication.endpoints.check");return this.event.broadcast("auth:check"),new e.Observable(function(e){!1===n.authenticated?n.checkResolve(e,!1):!0!==n.authenticated||t?n.httpService.tokenHeader().then(function(t){t?n.getUser(o).then(function(t){n.setAuthenticated(!0),n.setUser(t.data||t),n.event.broadcast("auth:loggedIn",n.user()),n.checkResolve(e,!0)},function(){n.setAuthenticated(!1),n.event.broadcast("auth:required",!0),n.checkResolve(e,!1)}):(n.setAuthenticated(!1),n.checkResolve(e,!1))},function(t){return e.error(t)}):(n.event.broadcast("auth:loggedIn",n.user()),n.checkResolve(e,!0))})},t.prototype.checkResolve=function(t,e){var n=this;this.event.broadcast("auth:check",e).then(function(){n.timeouts.checkResolve=setTimeout(function(){t.next(e)},100)})},t.prototype.eventListeners=function(){var e=this;this.subs["auth:loggedIn"]=this.event.listen("auth:loggedIn").subscribe(function(t){e.setAuthenticated(!0),e.setUser(t)})},t.prototype.forgotPassword=function(t,o,r){var i=this;return void 0===o&&(o=""),void 0===r&&(r={}),o=this.config.get("authentication.endpoints.forgotPassword",o),new Promise(function(e,n){return i.http.post(o,t,r).toPromise().then(function(t){return e(t)},function(t){return n(t)})})},t.prototype.getRedirect=function(){return this.redirect},t.prototype.getToken=function(){var t=this;return new Promise(function(e,n){t.token.get().then(function(t){return e(t)},function(t){return n(t)})})},t.prototype.getUser=function(t){return void 0===t&&(t=""),t=this.config.get("authentication.endpoints.getUser",t),this.http.get(t).toPromise()},t.prototype.getAuthenticated=function(){return this.authenticated},t.prototype.setAuthenticated=function(t){return this.authenticated=t},t.prototype.login=function(t,o,r){var i=this;return void 0===o&&(o=""),void 0===r&&(r={}),o=this.config.get("authentication.endpoints.login",o),new Promise(function(e,n){i.http.post(o,t,r).toPromise().then(function(t){i.onLogin(t).then(function(){return e(t)},function(t){return n(t)})},function(t){return n(t)})})},t.prototype.logout=function(t,o){var r=this;return void 0===t&&(t=""),void 0===o&&(o={}),new Promise(function(e,n){r.event.broadcast("auth:loggingOut").then(function(){(t=r.config.get("authentication.endpoints.logout",t))?r.http.post(t,{},o).toPromise().then(function(t){r.onLogout(),e(t)},function(t){return n(t)}):(r.onLogout(),e())})})},t.prototype.onLogin=function(n){var o=this;return new Promise(function(t,e){o.storeToken(n).then(function(){o.event.broadcast("auth:loggingIn",n).then(function(){o.resolveUser().then(function(){return t()},function(t){return e(t)})},function(t){return e(t)})},function(t){return e(t)})})},t.prototype.onLogout=function(){this.unauthenticate(),this.event.broadcast("auth:loggedOut")},t.prototype.pullRedirect=function(){var t=this.redirect;return this.redirect=null,t},t.prototype.register=function(t,o,r,i){var s=this;return void 0===o&&(o=""),void 0===r&&(r={}),void 0===i&&(i=!1),o=this.config.get("authentication.endpoints.register",o),new Promise(function(e,n){s.http.post(o,t,r).toPromise().then(function(t){i?s.onLogin(t).then(function(){e(t),s.event.broadcast("auth:registered",t)},function(t){return n(t)}):s.event.broadcast("auth:registered",t)},function(t){return n(t)})})},t.prototype.resetPassword=function(t,o,r){var i=this;return void 0===o&&(o=""),void 0===r&&(r={}),o=this.config.get("authentication.endpoints.resetPassword",o),new Promise(function(e,n){i.http.post(o,t,r).toPromise().then(function(t){i.onLogin(t).then(function(){return e(t)})},function(t){return n(t)})})},t.prototype.resolveUser=function(){var o=this;return new Promise(function(e,n){o.timeouts.resolveUser=setTimeout(function(){o.getUser().then(function(t){o.setAuthenticated(!0),o.setUser(t.data||t).then(function(t){o.event.broadcast("auth:loggedIn",t),e()},function(t){return n(t)})},function(t){return n(t)})},250)})},t.prototype.setRedirect=function(t){return this.redirect=t},t.prototype.setUser=function(e){var n=this;return e&&(e=new b(this.authorization,e)),new Promise(function(t){return t(n.authUser=e)})},t.prototype.storeToken=function(e){var n=this;return new Promise(function(t){n.token.set(n.token.read(e)).then(function(){t(e)},function(t){return console.error(t)})})},t.prototype.unauthenticate=function(){this.token.remove(),this.setAuthenticated(!1),this.setUser(null),this.authorization.clearPolicies()},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:m},{type:c},{type:a},{type:i.HttpClient},{type:p},{type:f}]},t}(),P=function(t,e){return(P=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function O(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var o,r,i=n.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(o=i.next()).done;)s.push(o.value)}catch(u){r={error:u}}finally{try{o&&!o.done&&(n=i["return"])&&n.call(i)}finally{if(r)throw r.error}}return s}var j=function(u){function t(t,e,n,o,r,i){var s=u.call(this,t,e,n,o,r,i)||this;return s.authorization=t,s.config=e,s.event=n,s.http=o,s.httpService=r,s.token=i,s.handleLoginError=function(t){return console.log(t)},s}return function e(t,e){function n(){this.constructor=t}P(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(t,u),t.prototype.handleLoginSuccess=function(t){var o=this;return new Promise(function(e,n){o.storeSocialCredentials(t),o.http.post(o.config.get("authentication.endpoints.socialAuth"),t).subscribe(function(t){o.onLogin(t).then(function(){e(t)},function(t){return n(t)})},function(t){return n(t)})})},t.prototype.storeSocialCredentials=function(t){"facebook"==t.network&&this.token.set(t.authResponse.accessToken,"facebook_access_token")},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:m},{type:c},{type:a},{type:i.HttpClient},{type:p},{type:f}]},t}(k),w=function(){function t(t,e,n){var o=this;this.config=t,this.event=e,this.storage=n,this.cacheName="ngkit_cache",this._cache={},this.subs={},this.retrieveCache(),this.subs["auth:loggedOut"]=this.event.listen("auth:loggedOut").subscribe(function(){o._cache={},o.clear()})}return t.prototype.ngOnDestroy=function(){var e=this;Object.keys(this.subs).forEach(function(t){return e.subs[t].unsubscribe()})},t.prototype.retrieveCache=function(){var n=this;return new Promise(function(t,e){n.storage.get(n.cacheName).then(function(e){e?(Object.keys(e).forEach(function(t){e[t]=new l(e[t])}),n.cache=e):n.cache=n.store(),t(n.cache)},function(t){return e(t)})})},t.prototype.store=function(){return this.storage.set(this.cacheName,this._cache),this._cache},Object.defineProperty(t.prototype,"cache",{get:function(){return this._cache},set:function(t){this._cache=t},enumerable:!0,configurable:!0}),t.prototype.get=function(t,e){return void 0===e&&(e=null),this.cache[t]&&!this.cache[t].isExpired()?this.cache[t].value:e||(this.remove(t),null)},t.prototype.set=function(t,e,n){void 0===n&&(n=this.config.get("cache.expires"));var o=new l({value:e,expires:n});this._cache[t]=o,this.store()},t.prototype.remove=function(t){delete this.cache[t],this.store()},t.prototype.clear=function(){this.storage.remove(this.cacheName)},t.prototype.pull=function(t){var e=this.get(t);return this.remove(t),e},t.prototype.has=function(t){return null!==this.get(t)},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:c},{type:a},{type:h}]},t}(),I=function(){function t(t,e){this.auth=t,this.event=e,this.subs={}}return t.prototype.ngOnDestroy=function(){var e=this;Object.keys(this.subs).forEach(function(t){return e.subs[t].unsubscribe()})},t.prototype.canActivate=function(t,e){return this.guard(t,e)},t.prototype.canActivateChild=function(t,e){return this.guard(t,e)},t.prototype.guard=function(t,n){var o=this;return new Promise(function(e){o.auth.user()?e(!0):o.subs["auth:check"]=o.auth.check().subscribe(function(t){t?e(!0):(o.event.broadcast("auth:modal"),o.auth.setRedirect(n.url),e(!1))})})},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:k},{type:a}]},t}(),_=function(){function t(t,e){this.auth=t,this.event=e,this.subs={}}return t.prototype.ngOnDestroy=function(){var e=this;Object.keys(this.subs).forEach(function(t){return e.subs[t].unsubscribe()})},t.prototype.canActivate=function(){return this.guard()},t.prototype.canActivateChild=function(){return this.guard()},t.prototype.guard=function(){var e=this;return new Promise(function(t){e.auth.user()?t(!0):e.subs["auth:check"]=e.auth.check().subscribe(function(){t(!0)})})},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:k},{type:a}]},t}(),x=function(){function t(t){this.http=t}return t.prototype.intercept=function(t,e){return t=t.clone({headers:this.http.headers,url:this.http.getUrl(t.url)}),e.handle(t)},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:p}]},t}(),A=function(){function t(t,e){this.http=t,this.event=e}return t.prototype.intercept=function(t,e){var n=this;return e.handle(t).pipe(u.tap(function(){},function(t){t instanceof i.HttpErrorResponse&&401===t.status&&n.event.broadcast("auth:required",t)}))},t.decorators=[{type:o.Injectable}],t.ctorParameters=function(){return[{type:p},{type:a}]},t}(),E=[k,I,_,j,m,c,h,w,a,p,f,{provide:i.HTTP_INTERCEPTORS,useClass:x,multi:!0},{provide:i.HTTP_INTERCEPTORS,useClass:A,multi:!0}],U=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:"ngKitOptions",useValue:t}]}},e.decorators=[{type:o.NgModule,args:[{imports:[i.HttpClientModule],providers:function t(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(O(arguments[e]));return t}(E)}]}],e}();t.Config=c,t.Authentication=k,t.Authorization=m,t.Cache=w,t.Event=a,t.Http=p,t.SocialAuthentication=j,t.Storage=h,t.Token=f,t.AuthGuard=I,t.AuthResolveGuard=_,t.NGKIT_PROVIDERS=E,t.Model=d,t.ngKitModule=U,t.ɵb=A,t.ɵa=x,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ngkit.umd.min.js.map